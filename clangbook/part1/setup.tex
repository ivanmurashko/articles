%% -*- coding:utf-8 -*-
\chapter{Environment setup}
The chapter describes basic steps to be done to set up the environment to be
used for future experiments with a clang. The setup is appropriate for
Unix-based systems such as Linux and Darwin (MacOS). In addition, the reader
will get important info on how to download, configure and build LLVM source
code.  


\section{Prerequisite}
Our primary goal will be clang frontend investigation and that will assume some
prerequisites that has to be installed.

There are
\begin{enumerate}
\item OS requirement (Linux, Darwin)
\item build tools (cmake, ninja)
\item debugger lldb
\end{enumerate}

\section{LLVM history and project structure}

There is a short history of LLVM project and brief overview into its
organization 

\subsection{Getting the source code}

The clang source is a part of LLVM. The LLVM evolves very fast thus some part of
the system can be changed dramatically between different LLVM versions. Fro this
book we will use specific version of LLVM (15) to avoid uncertainty between
revisions. You can get it with the following command
\begin{minted}{text}
  git clone https://github.com/llvm/llvm-project.git -b release/15.x
  cd llvm-project
\end{minted}

\section{Source code compilation}

We are going to compile our source code in debug mode to be suitable
for future investigations with debugger.

\subsection{Configuration with cmake}
Create a build folder where the compiler and related tools will be
built
\begin{minted}{text}
mkdir build
cd build
\end{minted}
Run configure script
\begin{minted}[breaklines]{text}
cmake -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DLLVM_TARGETS_TO_BUILD="X86" -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" -DLLVM_USE_LINKER=gold -DLLVM_USE_SPLIT_DWARF=ON ../llvm
\end{minted}
The are several options specified:
\begin{itemize}
  \item \mintinline{text}{-DLLVM_TARGETS_TO_BUILD="X86"} specifies exact
    targets to be build. It will avoid build unnecessary targets
  \item \mintinline{text}{LLVM_ENABLE_PROJECTS="clang;clang-tools-extra"}
    specifies LLVM projects that we care about
\item \mintinline{text}{LLVM_USE_LINKER=gold} - uses gold linker
\item \mintinline{text}{LLVM_USE_SPLIT_DWARF=ON} - spits debug information into
  separate files. This option saves disk space as well as memory
  consumption during the LLVM build. The option require compiler used
  for clang build to support it
\end{itemize}
For debugging purposes you might want to change the
\mintinline{text}{-DCMAKE_BUILD_TYPE} into
\mintinline{text}{Debug}. Thus you overall config command will look
like
\begin{minted}[breaklines]{text}
cmake -G Ninja -DCMAKE_BUILD_TYPE=Debug -DLLVM_TARGETS_TO_BUILD="X86" -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" -DLLVM_USE_LINKER=gold -DLLVM_USE_SPLIT_DWARF=ON ../llvm
\end{minted}


\subsection{Build}
The build is trivial
\begin{minted}{text}
ninja clang
\end{minted}
You can also run unit and end-to-end tests for the compiler with
\begin{minted}{text}
ninja check-clang
\end{minted}
The compiler binary can be found as \mintinline{text}{bin/clang} at the build folder. 
